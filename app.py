import os
from flask import Flask, request, jsonify, render_template # ุชูุช ุฅุฒุงูุฉ session
from google import genai
from flask_cors import CORS

# ===============================================
# ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ
# ===============================================

# ุชููุฆุฉ ุชุทุจูู Flask
app = Flask(__name__)
CORS(app)
# ูู ูุนุฏ ููุงู ุญุงุฌุฉ ูู app.secret_key ูุฃููุง ุฃุฒููุง session

# ===============================================
# 1. ุฅุนุฏุงุฏ ุงูุนููู ูุงูู API Key
# ===============================================

API_KEY = os.environ.get('GEMINI_API_KEY')
if API_KEY:
    client = genai.Client(api_key=API_KEY)
else:
    print("ุชุญุฐูุฑ: ูุชุบูุฑ ุงูุจูุฆุฉ GEMINI_API_KEY ุบูุฑ ููุฌูุฏ.")

# ===============================================
# 2. ููุทุฉ ุงูููุงูุฉ (Endpoint) ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
# ===============================================

@app.route('/')
def home():
    # ูู ูุนุฏ ูููุฆ ุงูุนุฏุงุฏ ูู ุงูุฌูุณุฉ
    return render_template('index.html')

# ===============================================
# 3. ููุทุฉ ุงูููุงูุฉ (Endpoint) ููุฏุฑุฏุดุฉ (ุฅูุบุงุก ููุทู ุงูุนุฏุงุฏ)
# ===============================================

@app.route('/chat', methods=['POST'])
def chat():
    if not API_KEY:
        return jsonify({"response": "ุนุฐุฑุงูุ ูู ูุชู ุฅุนุฏุงุฏ ููุชุงุญ API ุงูุฎุงุต ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ุนูู ุงูุฎุงุฏู."}), 500
    
    # ๐จ ุชูุช ุฅุฒุงูุฉ ุฌููุน ููุทู ุงูุชุญูู ูู session ู FREE_LIMIT ๐จ

    try:
        data = request.get_json()
        user_message = data.get('message', '')

        if not user_message:
            return jsonify({"response": "ุงูุฑุฌุงุก ุฅุฑุณุงู ุฑุณุงูุฉ ูุตูุฉ."})
        
        # ุชุญุฏูุฏ ุดุฎุตูุฉ ุงููุณุงุนุฏ ุงููุบูู (System Instruction)
        system_instruction = (
            "ุฃูุช ูุนูู ูุบุฉ ุฅูุฌููุฒูุฉ ูุฏูุฏ ููุญุชุฑูุ ูุชุฎุตุต ูู ุชุฏุฑูุจ ุงููุจุชุฏุฆูู ูุงููุชูุณุทูู. "
            "ูููุชู: 1. ุตุญุญ ุฃู ุฎุทุฃ ูุญูู ุฃู ุฅููุงุฆู ูุฑุชูุจู ุงููุณุชุฎุฏู. 2. ุงุดุฑุญ ุงูุชุตุญูุญ ุจุงุฎุชุตุงุฑ ูุจูุบุฉ ุนุฑุจูุฉ ุจุณูุทุฉ. 3. ุงุทุฑุญ ุณุคุงูุงู ูุงุญุฏุงู ูุฑุชุจุทุงู ุจููุถูุน ุงููุญุงุฏุซุฉ ูุชุดุฌูุน ุงููุณุชุฎุฏู ุนูู ุงููุชุงุจุนุฉ."
        )

        response = client.models.generate_content(
            model='gemini-2.5-flash',
            contents=user_message,
            config={'system_instruction': system_instruction}
        )

        return jsonify({'response': response.text})

    except Exception as e:
        print(f"ุญุฏุซ ุฎุทุฃ: {e}")
        return jsonify({"response": "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจู."}), 500

# ===============================================
# 4. ุชุดุบูู ุงูุฎุงุฏู
# ===============================================

if __name__ == '__main__':
    app.run(debug=True, port=5000)
